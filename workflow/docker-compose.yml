version: '3.8'

services:
  # n8n - Workflow Automation Platform
  n8n:
    image: n8nio/n8n:latest
    container_name: freight-n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_PASSWORD:-changeme}
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=http
      - NODE_ENV=production
      - WEBHOOK_URL=http://localhost:5678/
      - GENERIC_TIMEZONE=America/Toronto
    volumes:
      - n8n_data:/home/node/.n8n
      - ./n8n-workflows:/home/node/workflows
    networks:
      - freight-network

  # PostgreSQL - Database for n8n and Dify
  postgres:
    image: postgres:15-alpine
    container_name: freight-postgres
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER:-freight}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-freight123}
      - POSTGRES_DB=freight_automation
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./init-db.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "5432:5432"
    networks:
      - freight-network

  # Redis - Cache for Dify and n8n
  redis:
    image: redis:7-alpine
    container_name: freight-redis
    restart: unless-stopped
    command: redis-server --requirepass ${REDIS_PASSWORD:-redis123}
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - freight-network

  # Dify API - AI Orchestration Backend
  dify-api:
    image: langgenius/dify-api:latest
    container_name: freight-dify-api
    restart: unless-stopped
    environment:
      - MODE=api
      - SECRET_KEY=${DIFY_SECRET_KEY:-dify-secret-key-change-me}
      - DB_USERNAME=${POSTGRES_USER:-freight}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-freight123}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_DATABASE=freight_automation
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis123}
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD:-redis123}@redis:6379/1
      - WEB_API_CORS_ALLOW_ORIGINS=*
    depends_on:
      - postgres
      - redis
    ports:
      - "5001:5001"
    volumes:
      - dify_storage:/app/storage
    networks:
      - freight-network

  # Dify Worker - Background Job Processor
  dify-worker:
    image: langgenius/dify-api:latest
    container_name: freight-dify-worker
    restart: unless-stopped
    environment:
      - MODE=worker
      - SECRET_KEY=${DIFY_SECRET_KEY:-dify-secret-key-change-me}
      - DB_USERNAME=${POSTGRES_USER:-freight}
      - DB_PASSWORD=${POSTGRES_PASSWORD:-freight123}
      - DB_HOST=postgres
      - DB_PORT=5432
      - DB_DATABASE=freight_automation
      - REDIS_HOST=redis
      - REDIS_PORT=6379
      - REDIS_PASSWORD=${REDIS_PASSWORD:-redis123}
      - CELERY_BROKER_URL=redis://:${REDIS_PASSWORD:-redis123}@redis:6379/1
    depends_on:
      - postgres
      - redis
    volumes:
      - dify_storage:/app/storage
    networks:
      - freight-network

  # Dify Web - Frontend UI
  dify-web:
    image: langgenius/dify-web:latest
    container_name: freight-dify-web
    restart: unless-stopped
    environment:
      - CONSOLE_API_URL=http://localhost:5001
      - APP_API_URL=http://localhost:5001
    ports:
      - "3000:3000"
    depends_on:
      - dify-api
    networks:
      - freight-network

volumes:
  n8n_data:
    driver: local
  postgres_data:
    driver: local
  redis_data:
    driver: local
  dify_storage:
    driver: local

networks:
  freight-network:
    driver: bridge
